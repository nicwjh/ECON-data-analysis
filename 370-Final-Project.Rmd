---
title: "ECON 370 Final Project"
author: 'SD:2, 5, 17, 19, 28' 
date: "2022-11-8"
output:
  word_document: default
  pdf_document: default
---
#test again
# ============================================
# Set-up
# ============================================
```{r}
library(readr)
library(mosaic)
library(data.table)
install.packages("xlsx")
library('xlsx')
library(openxlsx)
library(mvtnorm)
library(tidyverse)
```
# ============================================
# Question 1 - Download Data
# ============================================

Note: r eval = FALSE prevents code chunk from running when data is already downloaded (the "switch" in our code).
Delete eval = FALSE for first run of code to download files.
```{r, eval=FALSE} 
for (i in 1998:2010){
  
url1 <- paste("http://www.nber.org/hcris/265-94/rnl_rpt265_94_", i , ".csv",sep = '')
url2 <- paste("http://www.nber.org/hcris/265-94/rnl_nmrc265_94_", i, "_long.csv", sep = '')
url3 <- paste("http://www.nber.org/hcris/265-94/rnl_alpha265_94_", i, "_long.csv", sep = '')

destfile <- paste("./hcris_raw/rnl_rpt265_94_", i , ".csv",sep = '')
download.file(url1,destfile)
destfile <- paste("./hcris_raw/rnl_nmrc265_94_", i, "_long.csv", sep = '')
download.file(url2,destfile)
destfile <- paste("./hcris_raw/rnl_alpha265_94_", i, "_long.csv", sep = '')
download.file(url2,destfile)
}
```

# ============================================
# Question 2 - Cleaning The Data
# ============================================

```{r}
# Read in all CSVs
for (i in 1998:2010){
  
rpt_name = paste("rpt", i, sep = '')
nmrc_name = paste("nmrc", i, sep = '')
alpha_name = paste("alpha", i, sep = '')

rpt <- read_csv(paste("./hcris_raw/rnl_rpt265_94_", i , ".csv",sep = ''), show_col_types = F)
nmrc <- read_csv(paste("./hcris_raw/rnl_nmrc265_94_", i, "_long.csv", sep = ''), show_col_types = F)
alpha  <- read_csv(paste("./hcris_raw/rnl_alpha265_94_", i, "_long.csv", sep = ''), show_col_types = F)

rpt$year = i
nmrc$year = i
alpha$year = i

#this code drops extra zeros
alpha$line_num = gsub("^0+","",alpha$line_num)
alpha$clmn_num = gsub("^0+","",alpha$clmn_num)

nmrc$line_num = gsub("^0+","",nmrc$line_num)
nmrc$clmn_num = gsub("^0+","",nmrc$clmn_num)

#now keys are correct here
nmrc$key = paste0(nmrc$wksht_cd, nmrc$line_num, nmrc$clmn_num)
alpha$key = paste0(alpha$wksht_cd, alpha$line_num, alpha$clmn_num)

assign(rpt_name, rpt)
assign(nmrc_name, nmrc)
assign(alpha_name, alpha)
}


variable_codes = read.csv("variable_codes.csv")
variable_codes$key = paste(variable_codes$worksheet, variable_codes$line, variable_codes$column, sep = '')

#drop ids not in variables.csv using a %in% b bool, loop
alpha_list = list(alpha1998, alpha1999, alpha2000, alpha2001, alpha2002, alpha2003,
              alpha2004, alpha2005, alpha2006, alpha2007, alpha2008, alpha2009,
              alpha2010)

nrmc_list = list(nmrc1998, nmrc1999, nmrc2000, nmrc2001, nmrc2002, nmrc2003,
             nmrc2004, nmrc2005, nmrc2006, nmrc2007, nmrc2008, nmrc2009,
             nmrc2010)

#this gets list of trues and falses that I think are correct
alpha2000$key %in% variable_codes$key
#use this to drop falses?

#dcast to convert L to W individually then merge, unit of obs should be report after this

# clean up environment
rm(rpt, nmrc, alpha, rpt_name, nmrc_name, alpha_name)



```

<<<<<<< Updated upstream
=======
## Cleaning The Data
```{r}
hcris_data <- read_csv("hcris_cleaned/hcris_1998.csv", show_col_types = F)

# rbind all 13 datasets
for (i in 1999:2010){
  current = paste("hcris_cleaned/hcris_", i, ".csv", sep = '')
  to_bind <- read_csv(current, show_col_types = F)
  hcris_data <- rbind(hcris_data, to_bind)
}

# Trying to match Alex's dataset (besides column ordering, which is slightly different)
colnames(hcris_data)[1] = "report_number"
hcris_data$prvdr_num = as.numeric(hcris_data$prvdr_num)

head(hcris_data)

# 1

# 2

# 3

# 4

# 5

# 6

# 7

# 8

# 9

# 10

# 11
## what to do about NA values? for now: just removing them here 
sort(unique(temp$chain_identity))

# remove observations with chain_indicator == NA | chain_identity == NA
temp2 = subset(temp, chain_indicator == "Y" | chain_indicator == "N")
temp3 = subset(temp2,chain_identity != "NA")
temp3 = as.data.table(temp3)

## need to set temp3 as data table

f_regex = "^FER|^FES|^FEN|^FR4E|^FREE|^FREI|^FRES|^FREN|^FREZ|^FRSE|^FRRE|\\bDRESENIUS\\b"
d_regex = "^DACITA|^DATIVA|^DAVIATA|^DANITA|^DVITA"
o_regex = "?!.*(^FER|^FES|^FEN|^FR4E|^FREE|^FREI|^FRES|^FREN|^FREZ|^FRSE|^FRRE|\\bDRESENIUS\\b
            |^DACITA|^DATIVA|^DAVIATA|^DANITA|^DVITA)"

#set chain_id column default to 0
temp3$chain_id = 0

# initialize chain_indicator variables 
for(i in 1:nrow(temp3)){
  if (temp3$chain_indicator[i] == "Y" & (grepl(d_regex, temp3$chain_identity[i], ignore.case = TRUE) == FALSE) &  (grepl(f_regex, temp3$chain_identity[i], ignore.case = TRUE) == FALSE) ){
    temp3$chain_id[i] = 1
  }
  else if (grepl(d_regex, temp3$chain_identity[i], ignore.case = TRUE) == TRUE){
    temp3$chain_id[i] = 2
  }
  else if (grepl(f_regex, temp3$chain_identity[i], ignore.case = TRUE) == TRUE){
    temp3$chain_id[i] = 3
  }
}

## ASK ALEX: why are there some DaVita and Fresenius entries with N for chain_indicator? should be a simple fix if these are meant to be included. Also, what else do we need to do to "clean" the chain variables? More standardizing names?

## this works for fresenius and davita but not for the others
temp3[grepl(f_regex,chain_identity,ignore.case = TRUE),chain_identity := 'FRESENIUS']
temp3[grepl(d_regex,chain_identity,ignore.case = TRUE),chain_identity := 'DAVITA']
## I think the issue with this one is the regex, not sure how I should change it
temp3[grepl(o_regex,chain_identity,ignore.case = TRUE),chain_identity := 'OTHER']

## this works to change chain_identity but then sets everything in chain_id to "other"
#temp3$chain_id[temp3$chain_id == 1] = (temp3$chain_identity[temp3$chain_id == 1] = "OTHER")
#temp3$chain_id[temp3$chain_id == 2] = (temp3$chain_identity[temp3$chain_id == 2] = "DAVITA")
#temp3$chain_id[temp3$chain_id == 3] = (temp3$chain_identity[temp3$chain_id == 3] = "FRESENIUS")


# 12

```
>>>>>>> Stashed changes

# ============================================
# Question 3 - Analysis 
# ============================================