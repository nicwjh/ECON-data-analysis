---
title: "ECON 370 Final Project"
author: 'SD:2, 5, 17, 19, 28' 
date: "2022-11-8"
output:
  word_document: default
  pdf_document: default
---
# ============================================
# Set-up
# ============================================
```{r}
library(readr)
library(mosaic)
library(data.table)
library("xlsx")
library(openxlsx)
library(mvtnorm)
library(tidyverse)
library(stringr)
```

# ============================================
# Question 1 - Download Data
# ============================================

Note: r eval = FALSE prevents code chunk from running when data is already downloaded (the "switch" in our code).
Delete eval = FALSE for first run of code to download files.
```{r eval=FALSE} 
for (i in 1998:2010){
  
url1 <- paste("http://www.nber.org/hcris/265-94/rnl_rpt265_94_", i , ".csv",sep = '')
url2 <- paste("http://www.nber.org/hcris/265-94/rnl_nmrc265_94_", i, "_long.csv", sep = '')
url3 <- paste("http://www.nber.org/hcris/265-94/rnl_alpha265_94_", i, "_long.csv", sep = '')

destfile <- paste("./hcris_raw/rnl_rpt265_94_", i , ".csv",sep = '')
download.file(url1,destfile)
destfile <- paste("./hcris_raw/rnl_nmrc265_94_", i, "_long.csv", sep = '')
download.file(url2,destfile)
destfile <- paste("./hcris_raw/rnl_alpha265_94_", i, "_long.csv", sep = '')
download.file(url3,destfile)

}
```

# ============================================
# Question 2 - Cleaning The Data
# ============================================

## Read in raw data
```{r}
# Helper function to return indices of dataframe with matching variable code 
parse = function(data, match){
  vars = grepl(match, data)
  indices = c()
  for (i in 1:length(vars)){
    if (vars[i]){
      indices = c(indices,i)
    }
  }
  indices
}

## DELETE THIS WHEN DONE: loading Alex's data for part 2
## note to all: use temp for cleaning data portion 
temp <- read_csv("hcris_panel_raw.csv")

variable_codes <- read.csv("variable_codes.csv")

# 0 pad lines and columns 
for (i in 1:nrow(variable_codes)){
  variable_codes$line[i] = str_pad(variable_codes$line[i], 5, pad = "0")
  variable_codes$column[i] = str_pad(variable_codes$column[i], 4, pad = "0")
}

# generate variable code keys 
variable_codes$key = paste(variable_codes$worksheet, variable_codes$line, variable_codes$column, sep = '')

# fix error in data
variable_codes$key[35] = "S000001001020300"

# regular expression to parse keys 
toMatch = paste(variable_codes$key, collapse = "|")

# Read in all CSVs 
for (i in 1998:2010){
  
rpt_name = paste("rpt", i, sep = '')
nmrc_name = paste("nmrc", i, sep = '')
alpha_name = paste("alpha", i, sep = '')

rpt <- read_csv(paste("hcris_raw/rnl_rpt265_94_", i , ".csv",sep = ''), show_col_types = F)
nmrc <- read_csv(paste("./hcris_raw/rnl_nmrc265_94_", i, "_long.csv", sep = ''), show_col_types = F)
alpha  <- read_csv(paste("./hcris_raw/rnl_alpha265_94_", i, "_long.csv", sep = ''), show_col_types = F)

## note: checked instructions, probably add in the year later (after merging) 
#rpt$year = i
#nmrc$year = i
#alpha$year = i

nmrc$key = paste(nmrc$wksht_cd, nmrc$line_num, nmrc$clmn_num, sep = '')
alpha$key = paste(alpha$wksht_cd, alpha$line_num, alpha$clmn_num, sep = '')

# parse alpha and nmrc data for matching variable codes 
indices = parse(nmrc$key, toMatch)
nmrc_parsed = nmrc[indices,]
indices = parse(alpha$key, toMatch)
alpha_parsed = alpha[indices,]

assign(rpt_name, rpt)
assign(nmrc_name, nmrc_parsed)
assign(alpha_name, alpha_parsed)
}

# clean up environment
rm(rpt, nmrc, alpha, rpt_name, nmrc_name, alpha_name, alpha_parsed, nmrc_parsed)
```

## Reformatting The Raw Data 
```{r}
# given a coded key string, function will return the corresponding variable name 
rename_key = function(key){
  for (i in 1:nrow(variable_codes)){
    if (key == variable_codes$key[i]){
      return(variable_codes$variable[i])
      stop()
    }
  }
}

# merge alpha and nmrc datasets for separate years 
long_1998 = merge(x = nmrc1998, y = alpha1998, by = "rpt_rec_num")
long_1999 = merge(x = nmrc1999, y = alpha1999, by = "rpt_rec_num")
long_2000 = merge(x = nmrc2000, y = alpha2000, by = "rpt_rec_num")
long_2001 = merge(x = nmrc2001, y = alpha2001, by = "rpt_rec_num")
long_2002 = merge(x = nmrc2002, y = alpha2002, by = "rpt_rec_num")
long_2003 = merge(x = nmrc2003, y = alpha2003, by = "rpt_rec_num")
long_2004 = merge(x = nmrc2004, y = alpha2004, by = "rpt_rec_num")
long_2005 = merge(x = nmrc2005, y = alpha2005, by = "rpt_rec_num")
long_2006 = merge(x = nmrc2006, y = alpha2006, by = "rpt_rec_num")
long_2007 = merge(x = nmrc2007, y = alpha2007, by = "rpt_rec_num")
long_2008 = merge(x = nmrc2008, y = alpha2008, by = "rpt_rec_num")
long_2009 = merge(x = nmrc2009, y = alpha2009, by = "rpt_rec_num")
long_2010 = merge(x = nmrc2010, y = alpha2010, by = "rpt_rec_num")


# code chunk here renames all the keys to the corresponding variable name. need to do this? not sure 
idkey <- data.frame("original" = variable_codes$key, "new" = variable_codes$variable)
long_1998$key.x <- dplyr::recode(
  long_1998$key.x,
  !!!setNames(as.character(idkey$new), idkey$original)
)
long_1998$key.y <- dplyr::recode(
  long_1998$key.y,
  !!!setNames(as.character(idkey$new), idkey$original)
)

### convert long to wide data 
## note: this line of code below is wrong. still not sure how to reformat long to wide properly 

wide_1998 = dcast(as.data.table(long_test),rpt_rec_num ~ key.x, value.var = c("itm_val_num"))

### add variable "year" for each of the 13 reports 


### save resulting data as hcris_YEAR.csv

```

## Cleaning The Data
```{r}
# 1

# 2

# 3

# 4

# 5

# 6

# 7

# 8

# 9

# 10

# 11
## what to do about NA values? for now: just removing them here 
sort(unique(temp$chain_identity))

# remove observations with chain_indicator == NA | chain_identity == NA
temp2 = subset(temp, chain_indicator == "Y" | chain_indicator == "N")
temp3 = subset(temp2,chain_identity != "NA")

temp3$chain_id = 0 # default for chain_indicator == "N"

# initialize chain_indicator variables 
for(i in 1:nrow(temp3)){
  if (temp3$chain_indicator[i] == "Y" & temp3$chain_identity[i] != "DAVITA" & temp3$chain_identity[i] != "FRESENIUS" ){
    temp3$chain_id[i] = 1
  }
  else if (temp3$chain_identity[i] == "DAVITA"){
    temp3$chain_id[i] = 2
  }
  else if (temp3$chain_identity[i] == "FRESENIUS"){
    temp3$chain_id[i] = 3
  }
}

## this line of code is not running, chain_identity not found 
temp3[grepl("DAVITA",chain_identity,ignore.case = TRUE),chain_identity := "DAVITA"]

# 12

```

# ============================================
# Question 3 - Analysis 
# ============================================
```{r}

```